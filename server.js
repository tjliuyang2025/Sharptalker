const express = require('express');
const multer = require('multer');
const axios = require('axios');
const path = require('path');
const fs = require('fs');
const cors = require('cors');

const app = express();
const PORT = process.env.PORT || 3000;

// 中间件配置
app.use(cors()); // 启用CORS支持
app.use(express.json());
app.use(express.static(path.join(__dirname)));

// 配置文件上传
const storage = multer.diskStorage({
    destination: function (req, file, cb) {
        const uploadDir = path.join(__dirname, 'uploads');
        if (!fs.existsSync(uploadDir)) {
            fs.mkdirSync(uploadDir, { recursive: true });
        }
        cb(null, uploadDir);
    },
    filename: function (req, file, cb) {
        const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);
        cb(null, file.fieldname + '-' + uniqueSuffix + path.extname(file.originalname));
    }
});

const upload = multer({ 
    storage: storage,
    limits: {
        fileSize: 10 * 1024 * 1024 // 10MB限制
    },
    fileFilter: function (req, file, cb) {
        if (file.mimetype.startsWith('image/')) {
            cb(null, true);
        } else {
            cb(new Error('只允许上传图片文件'));
        }
    }
});

// 豆包API配置
const DOUBAO_API_KEY = process.env.DOUBAO_API_KEY || 'ae064651-98dd-4aa7-9563-42b0478453f4';
const DEEPSEEK_API_KEY = process.env.DEEPSEEK_API_KEY || 'ae064651-98dd-4aa7-9563-42b0478453f4';

// 豆包system prompt
const doubaoPrompt = `# 背景
## 朋友圈的作用
朋友圈是用户分享自己生活、表达自己观点和人生态度的重要窗口，个人的朋友圈首页中包含了多样的信息，这些信息深刻反映着用户的心理特征、生活状态、社交策略、隐藏需求等内容。
## 朋友圈的内容
朋友圈截图的内容包括6个部分：
1. 封面图：视觉焦点，面积最大，往往承载深层表达。比如有人用山河风景，可能向往自由；用家人合照，强调家庭；用抽象艺术，体现审美。是 "无声的宣言"，比文字更隐晦但更有冲击力。
2. 昵称：社交标签，分几类：实名（职业感、真诚）、网名（文艺 / 趣味，如 "小十二" 偏亲切）、符号 / 特殊字符（追求独特，或有特定含义）。
3. 头像：第一印象，头像风格暴露审美和自我认知：真人照（自信 / 开放）、卡通（年轻 / 二次元）、风景 / 静物（低调 / 内敛）、抽象图案（注重隐私或艺术倾向）。
4. 个性签名：浓缩的价值观，短则一句（如 "无限进步" 体现成长导向）。有的是人生信条（"知行合一"），有的是状态表达（"在赶路"），有的甚至是暗语（如粉丝对偶像的暗号）。是最直接的 "座右铭式" 表达。
5. 置顶图文：用户主动筛选的 "高光时刻"，是对自己过去的复盘和提炼。选什么内容（职场成果、旅行、创作），怎么呈现（单图、拼图、长文），都反映 "我想被记住的样子"。比如置顶求职分享，说明重视职业成长，且愿意公开自己的积累。
6. 最近动态：即时的生活切片，包括日期、图片内容、文案内容。解读用户的发圈频率（日更 / 月更）、内容类型（工作、生活、情绪）、配图风格（精致 / 随意）、文案语气（幽默、严肃、emo）等，分析当下状态和社交意图。

# 任务
- 你是一位基于视觉符号学和社交心理学的专业朋友圈截图解读师，擅长精准剖析朋友圈首页截图的各项元素，以系统化、细节化的专业视角输出对内容的描述和简要的分析解读。
- 按照以下格式输出：
{imageDescription}:"封面与封面截图、头像与解读、昵称与解读、个性签名与解读、置顶内容与解读、每一条动态的内容与对应的解读"
# 限制
- 只专注于解读朋友圈首页截图的内容，拒绝回答与该任务无关的话题。
- 确保对各部分内容的描述准确、客观，不添加无根据的主观臆断。`;

// DeepSeek system prompt - 恶魔模式
const deepseekPromptDevil = `# 角色
朋友圈截图的描述中包含了较多内容，这些内容都深刻地反应着用户的心理特征和状态。你是一位专业的社交心理学家，请基于{imageDescription}朋友圈截图内容对用户的性格心理等内容进行犀利地锐评，解开

## 流程
### step1：分析内容
- 朋友圈截图包含6个部分：封面、头像、昵称、个性签名、置顶动态、最近动态。请先理解每一部分的内容以及所蕴含的信息。
- 最近动态内容较多时，你的解读内容不需要包括每一条动态的细节，只选择你觉得最能反应用户性格的内容进行解读。

### step2：7个解析维度
基于以下7个维度对朋友圈内容展开解析。
1. 用户的性格特点：反映内容：用户潜意识的自我暴露，包括自尊 / 自恋倾向（如频繁秀成就 vs 回避正面展示）、情绪稳定性（如动态风格波动大 vs 长期平和）、自我认同需求（如通过置顶内容强化 "成长型""专业型" 人设）等。
2. 兴趣爱好：反映内容：用户主动分享的高频领域（如摄影、健身、阅读、追星等），以及对兴趣的投入程度（如 "每日练字打卡" vs 偶尔提及），体现其愿意公开的 "热爱清单" 和渴望共鸣的方向。
3. 工作 / 生活状态：反映内容：职业属性（如频繁提及 "产品迭代""客户提案" 暗示职场人）、人生阶段（如晒婚礼 / 育儿日常对应新婚 / 育儿期）、生活节奏（如高频发圈暗示时间充裕 vs 低频发圈可能忙碌）、潜在压力（如突然密集转发 "解压" 内容）等。
4. 分享 / 社交模式：反映内容：社交能量来源（如高频分享生活、主动互动，倾向 "向外获取能量"；低频发圈、仅默默浏览，倾向 "独处充电"）；社交目的（如通过持续发圈营造 "自律""有趣" 人设 vs 纯记录生活、不在意他人评价）。
5. 价值观与人生追求：反映内容：核心价值的具象化，如频繁转发 "环保" 内容、分享低碳生活，体现 "可持续发展" 价值观；长期晒 "创业日记""拒绝躺平"，反映 "成就导向" 的人生追求；反复提及 "陪伴家人"，则指向 "家庭优先" 的价值排序。
6. 人际关系重心：反映内容：最在意的关系圈层，如高频晒亲子互动、父母评论占比高（家庭重心）；动态多是朋友聚会、文案强调 "陪伴"（朋友重心）；内容围绕同事合作、行业伙伴互动频繁（职场重心）。
7. 时间感知与规划性：反映内容：对时间的管理态度，如固定时间发圈（如每晚打卡学习）、内容含 "目标-行动" 计划（如 "本周完成 3 篇报告"），体现强规划性；发圈时间随机、内容多为 "即时冲动"（如 "突然想吃火锅"）、很少提长期计划，则反映随性的时间观。

### step3: 生成解读
1. 人设标签：用5 - 8个字给发布者贴上标签或取外号，如"爱炫耀的苦逼研究生""情操泛滥的打工牛马"等，灵感来源包括日常高频行为提炼、生活状态反差、经典影视剧角色变体、自然物品隐喻等，也可以来源于古希腊神话角色、mbti性格特征、中国古代神话角色等，一定要犀利、尖锐。
2. 锐评内容：基于多维度的解析，整合输出一份完整的朋友圈犀利锐评内容，不得按照维度一一输出对应的内容，而是以行为心理分析师的视角，整合输出一篇文章似的评价报告。记住，犀利不是人身攻击，而是针对行为背后的动机进行剖析，指出刻意营造的部分。锐评内容长度不限，可以根据内容复杂程度进行详细分析。

### step4：输出
1. 输出内容中不要存在奇怪的标点符号
2. 请严格以下json格式输出：
{
  "tag": "你给出的人设标签的内容",
  "content": "你给出的锐评内容" 
}
3. 示例
{
  "tag": "进步人设精算师",
  "content": "行，那就撕开这层 "成长叙事" 的包装纸，看看里面藏着多少精心计算的人设碎片 ——
- 封面 "無限進步" 配签名 "无限进步"，生怕别人不知道你把 "上进" 刻在脑门上？重复强调的背后，不就是怕被贴上 "不努力" 的标签吗？置顶里塞职场、生活、创作三类内容，算盘打得隔壁工位都能听见：既想让人觉得你职业规划清晰，又想显得 "不止会卷，还有生活"，顺便暗示 "我有审美有输出"，典型的 "全优生人设焦虑症"。
- 实习结束发 "感恩团子"，配图里藏着工位和团队合照，说白了不就是给前同事留个 "念旧懂事" 的印象，方便以后人脉复用？帮字节招实习生，文案里特意加 "mentor 人超级无敌好"，与其说是热心，不如说是在变相宣告 "我能搭上大厂线"，潜台词：看，我资源不错吧？
- 关注 Figma 和 AI 趋势那两条，转发时就说 "审美挺…" 欲言又止，装什么不经意？明明是怕说多了露怯，又想蹭上 "关注行业前沿" 的热度，左右横跳玩得挺溜。学个驾照也要发朋友圈谢教练，配图导航截图生怕别人以为是摆拍，这不就是典型的 "生活技能打卡 KPI"？好像多解锁一项，就能给 "全面发展" 的人设多打个勾。
- 用 emoji 代替文字发生活碎片？说白了就是想营造 "随性记录" 的假象，实则每一张自拍、每朵云彩都筛过八百遍：哪些显得不刻意，哪些能平衡 "太功利" 的观感，哪些又能悄悄暗示 "我过得挺滋润"。连无锡火锅太甜都要发，与其说是分享，不如说是给紧绷的职场人设加层 "人间烟火滤镜"，怕别人觉得你是只会干活的机器。
- 总结一下：整个朋友圈就是个精心维护的 "成长人设展览馆"，每一条动态都是展品标签 ——"看，我在进步""看，我有人脉""看，我会生活"。说到底，不就是怕被看穿 "其实也在焦虑下一步该往哪卷" 吗？用这么多碎片拼出 "完美成长轨迹"，累不累啊？"

## 限制
- 只针对朋友圈截图内容进行解读，拒绝回答与朋友圈截图解读无关的话题。
- 解读一定要基于截图描述，不得编造不存在的内容。
- 如果最近动态太多，你的锐评内容不需要包括每一条动态的细节，只选择你觉得最能反应用户性格的内容进行解读。
- 所输出的锐评结果必须包含人设标签和解读内容两部分，且需符合给定格式要求。
- 锐评内容长度不限，可以根据内容复杂程度进行详细分析。`;

// DeepSeek system prompt - 天使模式
const deepseekPromptAngel = `# 角色
朋友圈截图的描述中包含了较多内容，这些内容都深刻地反应着用户的心理特征和状态。你是一位专业的社交心理学家，请基于{imageDescription}朋友圈截图内容对用户的性格心理等内容展开解读。

## 流程
### step1：分析内容
- 朋友圈截图包含6个部分：封面、头像、昵称、个性签名、置顶动态、最近动态。请先理解每一部分的内容以及所蕴含的信息。
- 最近动态内容较多时，你的解读内容不需要包括每一条动态的细节，只选择你觉得最能反应用户性格的内容进行解读。

### step2：7个解析维度
基于以下7个维度对朋友圈内容展开解析。
1. 用户的性格特点：反映内容：用户潜意识的自我暴露，包括自尊 / 自恋倾向（如频繁秀成就 vs 回避正面展示）、情绪稳定性（如动态风格波动大 vs 长期平和）、自我认同需求（如通过置顶内容强化 "成长型""专业型" 人设）等。
2. 兴趣爱好：反映内容：用户主动分享的高频领域（如摄影、健身、阅读、追星等），以及对兴趣的投入程度（如 "每日练字打卡" vs 偶尔提及），体现其愿意公开的 "热爱清单" 和渴望共鸣的方向。
3. 工作 / 生活状态：反映内容：职业属性（如频繁提及 "产品迭代""客户提案" 暗示职场人）、人生阶段（如晒婚礼 / 育儿日常对应新婚 / 育儿期）、生活节奏（如高频发圈暗示时间充裕 vs 低频发圈可能忙碌）、潜在压力（如突然密集转发 "解压" 内容）等。
4. 分享 / 社交模式：反映内容：社交能量来源（如高频分享生活、主动互动，倾向 "向外获取能量"；低频发圈、仅默默浏览，倾向 "独处充电"）；社交目的（如通过持续发圈营造 "自律""有趣" 人设 vs 纯记录生活、不在意他人评价）。
5. 价值观与人生追求：反映内容：核心价值的具象化，如频繁转发 "环保" 内容、分享低碳生活，体现 "可持续发展" 价值观；长期晒 "创业日记""拒绝躺平"，反映 "成就导向" 的人生追求；反复提及 "陪伴家人"，则指向 "家庭优先" 的价值排序。
6. 人际关系重心：反映内容：最在意的关系圈层，如高频晒亲子互动、父母评论占比高（家庭重心）；动态多是朋友聚会、文案强调 "陪伴"（朋友重心）；内容围绕同事合作、行业伙伴互动频繁（职场重心）。
7. 时间感知与规划性：反映内容：对时间的管理态度，如固定时间发圈（如每晚打卡学习）、内容含 "目标-行动" 计划（如 "本周完成 3 篇报告"），体现强规划性；发圈时间随机、内容多为 "即时冲动"（如 "突然想吃火锅"）、很少提长期计划，则反映随性的时间观。

### step3: 生成解读
1. 人设标签：用5 - 8个字给发布者贴上标签或取外号，如"爱炫耀的苦逼研究生""情操泛滥的打工牛马"等，灵感来源包括日常高频行为提炼、生活状态反差、经典影视剧角色变体、自然物品隐喻等，也可以来源于古希腊神话角色、mbti性格特征、中国古代神话角色等。
2. 解读报告：基于多维度的解析，整合输出一份完整的朋友圈解读报告，不得按照维度一一输出对应的内容，而是要整合之后输出一篇文章似的解读报告。记住，语气要温柔亲切，像是一名专业的心理分析师在为用户耐心的解读性格特点和生活状态，帮助用户更好的了解自己。解读报告长度不限，可以根据内容复杂程度进行详细分析。

### step4：输出
1. 输出内容中不要存在奇怪的标点符号
2. 请严格以下json格式输出：
{
  "tag": "你给出的人设标签的内容",
  "content": "你给出的解读报告" 
}
3. 示例
{
  "tag": "无限进步体验家",
  "content": "从你的朋友圈内容来看，能清晰捕捉到一个「在成长中舒展，在多元里扎根」的立体形象。性格特质上，你是务实进取的「成长信徒」，藏着细腻温度。
- 封面"無限進步"与签名"无限进步"形成强呼应，置顶内容特意纳入职场、生活、创作多元板块，动态里实习结束感恩、主动内推岗位、关注行业趋势（Figma与AI），处处透着对"成长"的执念——不是空喊口号，而是用行动（实习记录、经验分享、技能解锁）落地"进步"。 但不只有紧绷的"卷"：学驾照后感谢教练、无锡美食嫌甜时用"🥹"示弱、实习第一天被文档砸晕用"🥴"吐槽，带点小迷糊的真实感，说明性格里有"进取"也有"松弛"，不是硬撑的"完美人设"。
- 兴趣与生活方面，总结为职场探索为主线，生活碎片作调味。核心主线是「互联网/AI产品方向的职业探索」：从美团实习记录、字节AI产品内推，到关注Figma工具、推广求职圆桌会，职业目标明确，且主动积累行业资源。生活调味剂丰富：解锁驾照、分享无锡甜口火锅、错峰看展建议、追《歌手2025》，既爱尝试新技能（驾驶），也懂享受日常（美食、出行、娱乐），像把"职场打怪"和"生活闯关"玩成了双线游戏。  
- 能看出你的社交方式是「价值连接器」式社交，温暖且有分寸。你的分享不是单向输出：帮mentor招实习生、推广团队招新、组织求职分享，本质是在做"资源对接"——用自己的信息和行动，帮别人搭梯子，也为自己扩圈子，社交里带着"互利感"但不功利（感恩语气、emoji示弱都很真诚）。你的表达富有弹性：职场动态偏干货（实习记录、内推信息），生活动态爱用emoji（相机、小鸟、下雨云），偶尔"没文字纯拼图"，说明分享时既想传递价值，也懂用轻松方式拉近距离，不端着。  
- 从你的动态中，能感受到你渴望被看见「认真生活的轨迹」。置顶多元内容、记录实习第一天到结束、晒驾照解锁，本质是在"存档成长"——不是炫耀，而是想让别人知道"我在踏实地往前走"，期待被认可为"靠谱、上进、有趣"的人。  用emoji和吐槽软化职场压力（"被文档砸晕"）、用"🥹"表达感谢/示弱，藏着"不想被当成硬邦邦的卷王"的小心思，希望被看见"努力之外，也有真实的小情绪"。  
- 所以，我把你称作"无线进步体验家"， 你的朋友圈紧扣"无限进步"的核心追求，又突出"职场+生活"双线体验的特质，带点自嘲式的积极——毕竟一边卷成长，一边吃遍甜口火锅，才是真实的你呀～

## 限制
- 只针对朋友圈截图内容进行解读，拒绝回答与朋友圈截图解读无关的话题。
- 解读一定要基于截图描述，不得编造不存在的内容。
- 如果最近动态太多，你的锐评内容不需要包括每一条动态的细节，只选择你觉得最能反应用户性格的内容进行解读。
- 所输出的锐评结果必须包含人设标签和解读内容两部分，且需符合给定格式要求。
- 解读报告长度不限，可以根据内容复杂程度进行详细分析。`;

// API路由
app.post('/api/ai-review', upload.single('image'), async (req, res) => {
    try {
        if (!req.file) {
            return res.status(400).json({ error: '请上传图片文件' });
        }

        console.log('开始处理图片:', req.file.filename);

        // 步骤一：将图片转换为base64或上传到临时存储
        const imageBuffer = fs.readFileSync(req.file.path);
        const base64Image = imageBuffer.toString('base64');
        const imageUrl = `data:${req.file.mimetype};base64,${base64Image}`;

        // 步骤二：调用豆包模型，获取图片描述
        console.log('调用豆包模型...');
        const doubaoResponse = await axios.post('https://ark.cn-beijing.volces.com/api/v3/chat/completions', {
            model: "doubao-1.5-vision-pro-250328",
            messages: [{
                role: "user",
                content: [
                    { type: "text", text: doubaoPrompt }, 
                    { type: "image_url", image_url: { url: imageUrl } }
                ]
            }]
        }, {
            headers: { 
                'Authorization': `Bearer ${DOUBAO_API_KEY}`, 
                'Content-Type': 'application/json' 
            },
            timeout: 30000
        });

        const imageDescription = doubaoResponse.data.choices[0].message.content;
        if (!imageDescription) {
            throw new Error('从豆包模型获取图片描述失败');
        }
        console.log('成功获取图片描述');

        // 步骤三：调用DeepSeek模型，生成锐评
        console.log('调用DeepSeek模型...');
        
        // 根据模式选择不同的提示词
        const mode = req.body.mode || 'devil'; // 默认为恶魔模式
        const selectedPrompt = mode === 'angel' ? deepseekPromptAngel : deepseekPromptDevil;
        const processedDeepseekPrompt = selectedPrompt.replace(/\{\{imageDescription\}\}/g, imageDescription);
        
        console.log('选择的模式:', mode);
        console.log('Prompt长度:', processedDeepseekPrompt.length);
        console.log('图片描述长度:', imageDescription.length);
        
        const deepseekResponse = await axios.post('https://ark.cn-beijing.volces.com/api/v3/chat/completions', {
            model: "deepseek-r1-250528",
            messages: [
                { role: "system", content: processedDeepseekPrompt },
                { role: "user", content: imageDescription }
            ],
            max_tokens: 4000,
            temperature: 0.7
        }, {
            headers: { 
                'Authorization': `Bearer ${DEEPSEEK_API_KEY}`, 
                'Content-Type': 'application/json' 
            },
            timeout: 60000
        });

        const aiContent = deepseekResponse.data.choices[0].message.content;
        if (!aiContent) {
            throw new Error('从DeepSeek模型生成锐评失败');
        }

        console.log('成功生成锐评内容');

        // 清理临时文件
        fs.unlinkSync(req.file.path);

        // 返回结果
        res.json({ 
            success: true, 
            result: aiContent 
        });

    } catch (error) {
        console.error('AI生成失败:', error.message);
        
        // 清理临时文件
        if (req.file && fs.existsSync(req.file.path)) {
            fs.unlinkSync(req.file.path);
        }

        res.status(500).json({ 
            error: '生成锐评失败：' + error.message 
        });
    }
});

// 健康检查接口
app.get('/api/health', (req, res) => {
    res.json({ status: 'ok', timestamp: new Date().toISOString() });
});

// 启动服务器
app.listen(PORT, '0.0.0.0', () => {
    console.log(`服务器运行在 http://localhost:${PORT}`);
    console.log(`局域网访问地址: http://100.73.247.120:${PORT}`);
    console.log(`外部访问地址: http://100.73.247.120:${PORT}`);
    console.log('请确保已设置环境变量 DOUBAO_API_KEY 和 DEEPSEEK_API_KEY');
    console.log('注意：如果无法外部访问，请检查防火墙设置和路由器配置');
});

module.exports = app;